<app-navbar [loggedIn]=loggedIn></app-navbar>
<ngx-loading [show]="loading" [config]="{ backdropBorderRadius: '0px', fullScreenBackdrop:true }"></ngx-loading>
<div class="space">
  <div *ngIf="submited==false" class="container">
    <div class="row">
      <div class="col-lg-12">
          <div class="progress">
              <div class="progress-bar" role="progressbar" [style.width]="percentageCompletion + '%'" aria-valuenow="25" aria-valuemin="0" aria-valuemax="100"></div>
            </div>
          <div>
            <p class="p-style" *ngIf="actualPage===1">Define los items de la cotización</p>
            <p class="p-style" *ngIf="actualPage===2">Escribe los detalles y las condiciones de garantía</p>
            <p class="p-style" *ngIf="actualPage===3">Si existe una imagen de referencia o modificaciones debes completar los campos</p>
            <p class="p-style" *ngIf="actualPage===4">Resumen</p>
          </div>
      </div>
    </div>
    <div [hidden]="actualPage!==1">
        <div class="container">
          <div class="row centered">
            <h5>Items</h5>
            <img src="../../assets/add.svg" width="18" height="18" (click)="addItem()">   
          </div>
        </div>
        <form #itemsForm="ngForm">
          <div class="container">
            <div class="row">
              <div class="col-lg-12">
                <div *ngFor="let item of items; let i = index" class="row">
                  <div class="vcenter">  
                    <img src="../../assets/minus.svg" width="18" height="18" (click)="removeItem(i)">     
                  </div>
                  <div class="col-lg-4">
                    <label>Nombre</label>
                      <div class="form-row">
                        <div class="col-md-12">
                          <input class="form-control form-control-sm"
                            type="text" 
                            placeholder="Nombre" 
                            required 
                            minlength="3" 
                            [(ngModel)]="item.name"
                            name="name{{i}}" 
                            #name="ngModel"
                            [ngClass]="{'is-valid': name.valid && name.touched, 'is-invalid': name.invalid && name.touched}">
                          <small *ngIf="name.invalid && name.touched" class="form-text text-muted-error">El nombre ingresado no es válido</small>
                        </div>
                      </div>
                  </div>
                  <div class="col-lg-2">
                    <label>Valor</label>
                      <div class="form-row">
                        <div class="col-md-12">
                          <input class="form-control form-control-sm"
                            placeholder="Precio" 
                            currencyMask 
                            [(ngModel)]="item.value" 
                            [options]="{ prefix: '$ ', thousands: ',', precision: 0}"
                            name="value{{i}}" 
                            #value="ngModel"/>
                        </div>
                      </div>
                  </div>
                  <div class="col-lg-2">
                    <label>Duración</label>
                      <div class="form-row">
                        <div class="col-md-5">
                          <input class="form-control form-control-sm"
                            type="text" 
                            placeholder="Valor" 
                            required 
                            minlength="1" 
                            pattern="[0-9]*"
                            [(ngModel)]="item.durationValue"
                            name="duration{{i}}" 
                            #duration="ngModel"
                            [ngClass]="{'is-valid': duration.valid && duration.touched, 'is-invalid': duration.invalid && duration.touched}">
                            <small *ngIf="duration.invalid && duration.touched" class="form-text text-muted-error">Debes indicar la duración del trabajo</small>
                        </div>
                        <div class="col-md-7">
                          <select 
                            class="form-control form-control-sm" 
                            name="durationTime{{i}}" 
                            required 
                            [(ngModel)]="item.durationTime"
                            #durationTime="ngModel"
                            [ngClass]="{'is-valid': durationTime.valid && durationTime.touched, 'is-invalid': durationTime.invalid && durationTime.touched}">
                              <option [ngValue]="null" disabled  selected>Elige</option>
                              <option *ngFor="let item of durationTimes" [ngValue]="item"> {{item}} </option>
                          </select>
                          <small *ngIf="durationTime.invalid && durationTime.touched"
                                  class="form-text text-muted-error">
                            !Debes seleccionar una opción!
                          </small>
                        </div>
                      </div>
                  </div>
                  <div class="col-lg-2">
                    <label>Garantía</label>
                    <div class="form-row">
                      <div class="col-md-5">
                        <input class="form-control form-control-sm"
                          type="text" 
                          placeholder="Valor" 
                          required 
                          minlength="1" 
                          pattern="[0-9]*"
                          [(ngModel)]="item.warrantyValue"
                          name="warranty{{i}}" 
                          #warranty="ngModel"
                          [ngClass]="{'is-valid': warranty.valid && warranty.touched, 'is-invalid': warranty.invalid && warranty.touched}">
                        <small *ngIf="warranty.invalid && warranty.touched" class="form-text text-muted-error">Debes indicar un tiempo de garantía</small>
                      </div>
                      <div class="col-md-7">
                        <select 
                          class="form-control form-control-sm" 
                          name="warrantyTime{{i}}" 
                          required 
                          [(ngModel)]="item.warrantyTime"
                          #warrantyTime="ngModel"
                          [ngClass]="{'is-valid': warrantyTime.valid && warrantyTime.touched, 'is-invalid': warrantyTime.invalid && warrantyTime.touched}">
                            <option [ngValue]="null" disabled  selected>Elige</option>
                            <option *ngFor="let item of warrantyTimes" [ngValue]="item"> {{item}} </option>
                        </select>
                        <small *ngIf="warrantyTime.invalid && warrantyTime.touched"
                                class="form-text text-muted-error">
                                Debes elegir una opción
                        </small>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </form>
        <div class="my-4"></div>
        <div class="text-center">
          <button 
            (click)='back()' 
            class="btn btn btn-outline-secondary">
              Atrás
          </button>
          <button 
            [disabled]="itemsForm.invalid || items.length < 1"
            [hidden]="actualPage===totalPage"
            (click)='next()'
            class="btn btn-outline-secondary">
              Siguiente
          </button>
        </div>
    </div>
    <div [hidden]="actualPage!==2">
      <div class="container">
        <form #detailsForm="ngForm">
            <div *ngFor="let item of items; let i = index" class="row">
                <div class="col-lg-12">
                  <h5>{{item.name}}</h5>
                </div>
                <div class="col-lg-6">
                  <label for="description">Descripción del trabajo</label>
                  <textarea 
                    class="form-control" 
                    id="description" 
                    rows="3"
                    required 
                    [(ngModel)]="item.workDescription" 
                    name="workDescription{{i}}"
                    #workDescription="ngModel"
                    [ngClass]="{'is-valid': workDescription.valid && workDescription.touched, 'is-invalid': workDescription.invalid && workDescription.touched}">
                  </textarea>
                  <small *ngIf="workDescription.untouched || workDescription.valid && workDescription.touched" class="form-text text-muted">Se conciso en la descripción, esto ayuda a nuestros expertos a estar preparados el día de la visita.</small>
                  <small *ngIf="workDescription.invalid && workDescription.touched" class="form-text text-muted-error">Debes describir el trabajo a realizar</small>
                </div>
                <div class="col-lg-6">
                  <label for="description">Condiciones de garantía</label>
                  <textarea 
                    class="form-control" 
                    id="description" 
                    rows="3"
                    required 
                    [(ngModel)]="item.warrantyDescription" 
                    name="warrantyDescription{{i}}"
                    #warrantyDescription="ngModel"
                    [ngClass]="{'is-valid': warrantyDescription.valid && warrantyDescription.touched, 'is-invalid': warrantyDescription.invalid && warrantyDescription.touched}">
                  </textarea>
                  <small *ngIf="warrantyDescription.untouched || warrantyDescription.valid && warrantyDescription.touched" class="form-text text-muted">Se conciso en la descripción, esto ayuda a nuestros expertos a estar preparados el día de la visita.</small>
                  <small *ngIf="warrantyDescription.invalid && warrantyDescription.touched" class="form-text text-muted-error">Debes describir el trabajo a realizar</small>
                </div>
                <hr class="col-lg-12">
              </div>
        </form>
        <div class="my-4"></div>
        <div class="text-center">
          <button 
            (click)='back()' 
            class="btn btn btn-outline-secondary">
              Atrás
          </button>
          <button 
            [disabled]="detailsForm.invalid"
            [hidden]="actualPage===totalPage"
            (click)='next()'
            class="btn btn-outline-secondary">
              Siguiente
          </button>
        </div>
      </div>
    </div>
    <div [hidden]="actualPage!==3">
      <div class="container">
        <div class="form-group">
          <label for="file">Elige una imagen para subir</label>
           <div class="custom-file">
              <input 
                type="file" 
                class="custom-file-input" 
                id="file" 
                lang="es" 
                (change)="onFileChange($event)">
              <label class="custom-file-label" for="customFileLang">{{fileName}}</label>
            </div>
        </div>
        <div class="row">
            <div class="col-lg-2">
                <img 
                data-src="holder.js/200x200" 
                class="rounded mx-auto d-block" 
                alt="100x100" 
                src="data:image/svg+xml;charset=UTF-8,%3Csvg%20width%3D%22200%22%20height%3D%22200%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20viewBox%3D%220%200%20200%20200%22%20preserveAspectRatio%3D%22none%22%3E%3Cdefs%3E%3Cstyle%20type%3D%22text%2Fcss%22%3E%23holder_164e3f66702%20text%20%7B%20fill%3Argba(255%2C255%2C255%2C.75)%3Bfont-weight%3Anormal%3Bfont-family%3AHelvetica%2C%20monospace%3Bfont-size%3A10pt%20%7D%20%3C%2Fstyle%3E%3C%2Fdefs%3E%3Cg%20id%3D%22holder_164e3f66702%22%3E%3Crect%20width%3D%22200%22%20height%3D%22200%22%20fill%3D%22%23777%22%3E%3C%2Frect%3E%3Cg%3E%3Ctext%20x%3D%2274.4296875%22%20y%3D%22104.5%22%3E200x200%3C%2Ftext%3E%3C%2Fg%3E%3C%2Fg%3E%3C%2Fsvg%3E" 
                data-holder-rendered="true" 
                style="width: 150px; height: 150px; margin:5px;">
            </div>
            <div class="col-lg-10">
                <label for="modifications">Modificaciones al diseño</label>
                <textarea 
                  class="form-control" 
                  id="modifications" 
                  rows="4"
                  required 
                  [(ngModel)]="mModifications" 
                  name="modifications"
                  #modifications="ngModel"
                  [ngClass]="{'is-valid': modifications.valid && modifications.touched, 'is-invalid': modifications.invalid && modifications.touched}">
                </textarea>
                <small *ngIf="modifications.untouched || modifications.valid && modifications.touched" class="form-text text-muted">Se conciso en la descripción, esto ayuda a nuestros expertos a estar preparados el día de la visita.</small>
                <small *ngIf="modifications.invalid && modifications.touched" class="form-text text-muted-error">Debes describir el trabajo a realizar</small>
            </div>
        </div>             
        <div class="my-4"></div>
        <div class="text-center">
          <button 
            (click)='back()' 
            class="btn btn btn-outline-secondary">
              Atrás
          </button>
          <button 
            (click)="calculatePrice()"
            [disabled]="detailsForm.invalid"
            [hidden]="actualPage===totalPage"
            (click)='next()'
            class="btn btn-outline-secondary">
              Siguiente
          </button>
        </div>
      </div>
    </div>
    <div [hidden]="actualPage!==4">
      <div class="container">
        <div class="row">
          <div class="col-lg-12">
            <div class="table-responsive">
              <table class="table table-hover">
                <thead>
                  <tr>
                    <th scope="col">Nombre</th>
                    <th scope="col">Valor</th>
                    <th scope="col">Duración</th>
                    <th scope="col">Garantía</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor='let item of items'>
                    <td>{{item.name}}</td>
                    <td>$ {{item.value | number:0}}</td>
                    <td>{{item.durationValue}} {{item.durationTime}}</td>
                    <td>{{item.warrantyValue}} {{item.warrantyTime}}</td>
                  </tr>
                </tbody>
              </table>
            </div> 
          </div>
        </div>
        <div class="container">
            <div class="row">
              <div class="col-lg-12">
                  <p><strong>Subtotal:</strong>   $ {{subtotalAmount | number:0}}</p>
              </div>
              <div class="col-lg-12">
                  <p><strong>Costo administración:</strong>  $ {{administrationAmount | number:0}}</p>
              </div>
              <div class="col-lg-12">
                  <p><strong>Valor total:</strong>  $ {{totalAmount | number:0}}</p>
              </div>
            </div>
        </div>
        <div class="my-4"></div>
        <div class="text-center">
          <button 
            (click)='back()' 
            class="btn btn btn-outline-secondary">
              Atrás
          </button>
          <button 
            [disabled]="items.length < 1"
            (click)='submit()' 
            class="btn btn-outline-success">
              Enviar Cotización
          </button>
        </div>
      </div>
    </div>

        